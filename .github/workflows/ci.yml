name: CI - Build and Test

on:
  pull_request:
    branches:
      - main
  push:
    branches-ignore:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: ğŸ“¦ Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: ğŸ“¥ Install dependencies
      run: |
        uv sync
    
    - name: ğŸ§¹ Lint with ruff
      run: |
        uv run ruff check src/
      continue-on-error: true
    
    - name: ğŸ¨ Check formatting with black
      run: |
        uv run black --check src/
      continue-on-error: true
    
    - name: ğŸ§ª Run tests
      run: |
        uv run pytest -v
      continue-on-error: true
  
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ—ï¸ Build Docker image
      run: |
        docker build -t etf-agent:test .
    
    - name: ğŸ§ª Test Docker image
      run: |
        # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        docker run -d --name test-container -p 8000:8000 \
          -e APPLICATIONINSIGHTS_CONNECTION_STRING="InstrumentationKey=test" \
          -e COSMOS_ENDPOINT="https://test.documents.azure.com:443/" \
          -e COSMOS_KEY="test-key" \
          -e COSMOS_DATABASE_NAME="test-db" \
          -e COSMOS_CONTAINER_NAME="test-container" \
          -e OPENAI_API_KEY="sk-test" \
          etf-agent:test
        
        # Health check ëŒ€ê¸°
        sleep 10
        
        # Health check í…ŒìŠ¤íŠ¸
        for i in {1..30}; do
          if curl -f http://localhost:8000/health; then
            echo "âœ… Health check ì„±ê³µ!"
            docker logs test-container
            docker stop test-container
            exit 0
          fi
          echo "â³ Health check ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 2
        done
        
        echo "âŒ Health check ì‹¤íŒ¨"
        docker logs test-container
        docker stop test-container
        exit 1
