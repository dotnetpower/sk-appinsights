name: Deploy to Azure Container App

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  CONTAINER_REGISTRY_NAME: crskappinsights
  RESOURCE_GROUP: rg-sk-appinsights
  CONTAINER_APP_NAME: etf-agent-app
  IMAGE_NAME: etf-agent
  COSMOS_ACCOUNT_NAME: ${{ secrets.COSMOS_ACCOUNT_NAME || 'cosmosskappinsights' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Azure Login (Service Principal)
      run: |
        # AZURE_CREDENTIALS Secretì—ì„œ ê°’ ì¶”ì¶œ
        CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')
        CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')
        TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')
        SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')
        
        # Azure CLI ë¡œê·¸ì¸
        az login --service-principal \
          --username $CLIENT_ID \
          --password $CLIENT_SECRET \
          --tenant $TENANT_ID
        
        # êµ¬ë… ì„¤ì •
        az account set --subscription $SUBSCRIPTION_ID
        
        echo "âœ… Azure ë¡œê·¸ì¸ ì™„ë£Œ"
    
    - name: ğŸ³ Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.CONTAINER_REGISTRY_NAME }}
    
    - name: ğŸ—ï¸ Build Docker image
      run: |
        docker build \
          --build-arg REACT_APP_VERSION="0.1.0" \
          --build-arg REACT_APP_GIT_COMMIT="${{ github.sha }}" \
          --build-arg REACT_APP_BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          --build-arg REACT_APP_API_URL="" \
          -t ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          -t ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          .
    
    - name: ğŸ“¤ Push Docker image
      run: |
        docker push ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
    
    - name: ğŸš€ Deploy to Azure Container App
      run: |
        # Container Appì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if az containerapp show --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
          echo "âœ… Container App ì—…ë°ì´íŠ¸ ì¤‘..."
          
          # Secrets ì—…ë°ì´íŠ¸
          echo "ğŸ” Secrets ì—…ë°ì´íŠ¸ ì¤‘..."
          az containerapp secret set \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --secrets \
              appinsights-connection-string="${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}" \
              cosmos-endpoint="${{ secrets.COSMOS_ENDPOINT }}" \
              cosmos-database-name="${{ secrets.COSMOS_DATABASE_NAME }}" \
              cosmos-container-name="${{ secrets.COSMOS_CONTAINER_NAME }}" \
              azure-openai-endpoint="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
              azure-openai-api-key="${{ secrets.AZURE_OPENAI_API_KEY }}" \
              azure-openai-deployment-name="${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}" \
              azure-openai-api-version="${{ secrets.AZURE_OPENAI_API_VERSION }}" \
              alpha-vantage-key="${{ secrets.ALPHA_VANTAGE_KEY }}" \
            --output none
          
          # ì´ë¯¸ì§€ ë° í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸
          echo "ğŸ”„ ì´ë¯¸ì§€ ë° í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ì¤‘..."
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --set-env-vars \
              "APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:appinsights-connection-string" \
              "COSMOS_ENDPOINT=secretref:cosmos-endpoint" \
              "COSMOS_DATABASE_NAME=secretref:cosmos-database-name" \
              "COSMOS_CONTAINER_NAME=secretref:cosmos-container-name" \
              "AZURE_OPENAI_ENDPOINT=secretref:azure-openai-endpoint" \
              "AZURE_OPENAI_API_KEY=secretref:azure-openai-api-key" \
              "AZURE_OPENAI_DEPLOYMENT_NAME=secretref:azure-openai-deployment-name" \
              "AZURE_OPENAI_API_VERSION=secretref:azure-openai-api-version" \
              "ALPHA_VANTAGE_KEY=secretref:alpha-vantage-key"
          
          echo "âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        else
          echo "ğŸ“¦ ìƒˆë¡œìš´ Container App ìƒì„± ì¤‘..."
          
          # ACR ìê²©ì¦ëª… ê°€ì ¸ì˜¤ê¸°
          ACR_USERNAME=$(az acr credential show --name ${{ env.CONTAINER_REGISTRY_NAME }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ env.CONTAINER_REGISTRY_NAME }} --query passwords[0].value -o tsv)
          
          # Container App Environment ìƒì„± (ì—†ëŠ” ê²½ìš°)
          if ! az containerapp env show --name etf-agent-env --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            az containerapp env create \
              --name etf-agent-env \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --location koreacentral
          fi
          
          # Container App ìƒì„±
          az containerapp create \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment etf-agent-env \
            --image ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --registry-server ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io \
            --registry-username $ACR_USERNAME \
            --registry-password $ACR_PASSWORD \
            --target-port 8000 \
            --ingress external \
            --min-replicas 1 \
            --max-replicas 3 \
            --cpu 0.5 \
            --memory 1Gi \
            --secrets \
              appinsights-connection-string="${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}" \
              cosmos-endpoint="${{ secrets.COSMOS_ENDPOINT }}" \
              cosmos-database-name="${{ secrets.COSMOS_DATABASE_NAME }}" \
              cosmos-container-name="${{ secrets.COSMOS_CONTAINER_NAME }}" \
              azure-openai-endpoint="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
              azure-openai-api-key="${{ secrets.AZURE_OPENAI_API_KEY }}" \
              azure-openai-deployment-name="${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}" \
              azure-openai-api-version="${{ secrets.AZURE_OPENAI_API_VERSION }}" \
              alpha-vantage-key="${{ secrets.ALPHA_VANTAGE_KEY }}" \
            --env-vars \
              "APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:appinsights-connection-string" \
              "COSMOS_ENDPOINT=secretref:cosmos-endpoint" \
              "COSMOS_DATABASE_NAME=secretref:cosmos-database-name" \
              "COSMOS_CONTAINER_NAME=secretref:cosmos-container-name" \
              "AZURE_OPENAI_ENDPOINT=secretref:azure-openai-endpoint" \
              "AZURE_OPENAI_API_KEY=secretref:azure-openai-api-key" \
              "AZURE_OPENAI_DEPLOYMENT_NAME=secretref:azure-openai-deployment-name" \
              "AZURE_OPENAI_API_VERSION=secretref:azure-openai-api-version" \
              "ALPHA_VANTAGE_KEY=secretref:alpha-vantage-key"
        fi
    
    - name: ğŸ”’ Configure Cosmos DB Network Access
      run: |
        echo "=========================================="
        echo "ğŸ”’ Cosmos DB ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ ì„¤ì • ì¤‘..."
        echo "=========================================="
        
        # Container App Environmentì˜ outbound IP ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
        echo "ğŸ“ Container App Environmentì˜ Static IP ì£¼ì†Œ í™•ì¸ ì¤‘..."
        ENV_NAME=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "properties.environmentId" -o tsv | xargs basename)
        
        STATIC_IP=$(az containerapp env show \
          --name $ENV_NAME \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "properties.staticIp" -o tsv)
        
        echo "âœ… Container App Environment: $ENV_NAME"
        echo "âœ… Static IP: $STATIC_IP"
        
        # Cosmos DB í˜„ì¬ IP ê·œì¹™ í™•ì¸
        echo ""
        echo "ğŸ“‹ í˜„ì¬ Cosmos DB IP ê·œì¹™ í™•ì¸ ì¤‘..."
        CURRENT_IPS=$(az cosmosdb show \
          --name ${{ env.COSMOS_ACCOUNT_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "ipRules[].ipAddressOrRange" -o tsv)
        
        if [ -z "$CURRENT_IPS" ]; then
          echo "âš ï¸  í˜„ì¬ IP ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          echo "í˜„ì¬ í—ˆìš©ëœ IP ëª©ë¡:"
          echo "$CURRENT_IPS"
        fi
        
        # Container App IPê°€ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if echo "$CURRENT_IPS" | grep -q "$STATIC_IP"; then
          echo "âœ… Container App IP ($STATIC_IP)ê°€ ì´ë¯¸ í—ˆìš© ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤."
        else
          echo ""
          echo "â• Container App IPë¥¼ Cosmos DB ë°©í™”ë²½ ê·œì¹™ì— ì¶”ê°€ ì¤‘..."
          
          # ê¸°ì¡´ IPì™€ ìƒˆ IPë¥¼ ê²°í•©
          if [ -z "$CURRENT_IPS" ]; then
            NEW_IP_RULES="$STATIC_IP"
          else
            # ê¸°ì¡´ IPë“¤ì„ ë°°ì—´ë¡œ ë³€í™˜
            IFS=$'\n' read -rd '' -a IP_ARRAY <<< "$CURRENT_IPS" || true
            NEW_IP_RULES="$STATIC_IP"
            for ip in "${IP_ARRAY[@]}"; do
              NEW_IP_RULES="$NEW_IP_RULES,$ip"
            done
          fi
          
          # Cosmos DB ë°©í™”ë²½ ê·œì¹™ ì—…ë°ì´íŠ¸
          az cosmosdb update \
            --name ${{ env.COSMOS_ACCOUNT_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --ip-range-filter "$NEW_IP_RULES"
          
          echo "âœ… Container App IP ($STATIC_IP)ë¥¼ ë°©í™”ë²½ ê·œì¹™ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤."
        fi
        
        # ìµœì¢… í™•ì¸
        echo ""
        echo "ğŸ“‹ ì—…ë°ì´íŠ¸ëœ Cosmos DB IP ê·œì¹™:"
        az cosmosdb show \
          --name ${{ env.COSMOS_ACCOUNT_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "ipRules[].ipAddressOrRange" -o tsv
        
        echo ""
        echo "âœ… Cosmos DB ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì™„ë£Œ!"
    
    - name: ğŸ‰ Get App URL
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn -o tsv)
        
        echo "=========================================="
        echo "ğŸš€ ë°°í¬ ì™„ë£Œ!"
        echo "=========================================="
        echo "ğŸŒ Frontend URL: https://$APP_URL"
        echo "ğŸ”§ Backend API URL: https://$APP_URL/api"
        echo "ğŸ’š Health Check: https://$APP_URL/health"
        echo "ğŸ“š API Docs: https://$APP_URL/docs"
        echo "=========================================="
        
        # GitHub Step Summaryì— ì¶”ê°€
        echo "## ğŸ‰ ë°°í¬ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ ì ‘ì† URL" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ì„œë¹„ìŠ¤ | URL |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| **Frontend** | https://$APP_URL |" >> $GITHUB_STEP_SUMMARY
        echo "| **Backend API** | https://$APP_URL/api |" >> $GITHUB_STEP_SUMMARY
        echo "| **Health Check** | https://$APP_URL/health |" >> $GITHUB_STEP_SUMMARY
        echo "| **API Docs** | https://$APP_URL/docs |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ·ï¸ **Image Tag**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“… **ë°°í¬ ì‹œê°„**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
