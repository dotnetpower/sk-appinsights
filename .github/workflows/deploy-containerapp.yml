name: Deploy to Azure Container App

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  CONTAINER_REGISTRY_NAME: crskappinsights
  RESOURCE_GROUP: rg-sk-appinsights
  CONTAINER_APP_NAME: etf-agent-app
  IMAGE_NAME: etf-agent

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ” Azure Login (Service Principal)
      run: |
        # AZURE_CREDENTIALS Secretì—ì„œ ê°’ ì¶”ì¶œ
        CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')
        CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')
        TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')
        SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')
        
        # Azure CLI ë¡œê·¸ì¸
        az login --service-principal \
          --username $CLIENT_ID \
          --password $CLIENT_SECRET \
          --tenant $TENANT_ID
        
        # êµ¬ë… ì„¤ì •
        az account set --subscription $SUBSCRIPTION_ID
        
        echo "âœ… Azure ë¡œê·¸ì¸ ì™„ë£Œ"
    
    - name: ðŸ³ Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.CONTAINER_REGISTRY_NAME }}
    
    - name: ðŸ—ï¸ Build Docker image
      run: |
        docker build -t ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                     -t ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
                     .
    
    - name: ðŸ“¤ Push Docker image
      run: |
        docker push ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
    
    - name: ðŸš€ Deploy to Azure Container App
      run: |
        # Container Appì´ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
        if az containerapp show --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
          echo "âœ… Container App ì—…ë°ì´íŠ¸ ì¤‘..."
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        else
          echo "ðŸ“¦ ìƒˆë¡œìš´ Container App ìƒì„± ì¤‘..."
          
          # ACR ìžê²©ì¦ëª… ê°€ì ¸ì˜¤ê¸°
          ACR_USERNAME=$(az acr credential show --name ${{ env.CONTAINER_REGISTRY_NAME }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ env.CONTAINER_REGISTRY_NAME }} --query passwords[0].value -o tsv)
          
          # Container App Environment ìƒì„± (ì—†ëŠ” ê²½ìš°)
          if ! az containerapp env show --name etf-agent-env --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            az containerapp env create \
              --name etf-agent-env \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --location koreacentral
          fi
          
          # Secrets ì¤€ë¹„ (ê°’ì´ ìžˆëŠ” ê²ƒë§Œ ì¶”ê°€)
          SECRETS=""
          if [ -n "${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}" ]; then
            SECRETS="$SECRETS appinsights-connection-string=\"${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}\""
          fi
          if [ -n "${{ secrets.COSMOS_ENDPOINT }}" ]; then
            SECRETS="$SECRETS cosmos-endpoint=\"${{ secrets.COSMOS_ENDPOINT }}\""
          fi
          if [ -n "${{ secrets.COSMOS_KEY }}" ]; then
            SECRETS="$SECRETS cosmos-key=\"${{ secrets.COSMOS_KEY }}\""
          fi
          if [ -n "${{ secrets.COSMOS_DATABASE_NAME }}" ]; then
            SECRETS="$SECRETS cosmos-database-name=\"${{ secrets.COSMOS_DATABASE_NAME }}\""
          fi
          if [ -n "${{ secrets.COSMOS_CONTAINER_NAME }}" ]; then
            SECRETS="$SECRETS cosmos-container-name=\"${{ secrets.COSMOS_CONTAINER_NAME }}\""
          fi
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            SECRETS="$SECRETS openai-api-key=\"${{ secrets.OPENAI_API_KEY }}\""
          fi
          if [ -n "${{ secrets.ALPHA_VANTAGE_API_KEY }}" ]; then
            SECRETS="$SECRETS alphavantage-api-key=\"${{ secrets.ALPHA_VANTAGE_API_KEY }}\""
          fi
          if [ -n "${{ secrets.FINNHUB_API_KEY }}" ]; then
            SECRETS="$SECRETS finnhub-api-key=\"${{ secrets.FINNHUB_API_KEY }}\""
          fi
          
          # í™˜ê²½ë³€ìˆ˜ ì¤€ë¹„
          ENV_VARS="LOG_LEVEL=INFO"
          if [ -n "${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}" ]; then
            ENV_VARS="$ENV_VARS APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:appinsights-connection-string"
          fi
          if [ -n "${{ secrets.COSMOS_ENDPOINT }}" ]; then
            ENV_VARS="$ENV_VARS COSMOS_ENDPOINT=secretref:cosmos-endpoint"
          fi
          if [ -n "${{ secrets.COSMOS_KEY }}" ]; then
            ENV_VARS="$ENV_VARS COSMOS_KEY=secretref:cosmos-key"
          fi
          if [ -n "${{ secrets.COSMOS_DATABASE_NAME }}" ]; then
            ENV_VARS="$ENV_VARS COSMOS_DATABASE_NAME=secretref:cosmos-database-name"
          fi
          if [ -n "${{ secrets.COSMOS_CONTAINER_NAME }}" ]; then
            ENV_VARS="$ENV_VARS COSMOS_CONTAINER_NAME=secretref:cosmos-container-name"
          fi
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            ENV_VARS="$ENV_VARS OPENAI_API_KEY=secretref:openai-api-key"
          fi
          if [ -n "${{ secrets.ALPHA_VANTAGE_API_KEY }}" ]; then
            ENV_VARS="$ENV_VARS ALPHA_VANTAGE_API_KEY=secretref:alphavantage-api-key"
          fi
          if [ -n "${{ secrets.FINNHUB_API_KEY }}" ]; then
            ENV_VARS="$ENV_VARS FINNHUB_API_KEY=secretref:finnhub-api-key"
          fi
          
          # Container App ìƒì„± (secretsì™€ env-varsê°€ ìžˆëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€)
          CREATE_CMD="az containerapp create \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment etf-agent-env \
            --image ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --registry-server \"${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io\" \
            --registry-username $ACR_USERNAME \
            --registry-password $ACR_PASSWORD \
            --target-port 8000 \
            --ingress external \
            --min-replicas 1 \
            --max-replicas 3 \
            --cpu 0.5 \
            --memory 1Gi"
          
          if [ -n "$SECRETS" ]; then
            CREATE_CMD="$CREATE_CMD --secrets $SECRETS"
          fi
          
          if [ -n "$ENV_VARS" ]; then
            CREATE_CMD="$CREATE_CMD --env-vars \"$ENV_VARS\""
          fi
          
          eval $CREATE_CMD
        fi
    
    - name: ðŸŽ‰ Get App URL
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn -o tsv)
        
        echo "=========================================="
        echo "ðŸš€ ë°°í¬ ì™„ë£Œ!"
        echo "=========================================="
        echo "ðŸ“ App URL: https://$APP_URL"
        echo "ðŸ“ Health: https://$APP_URL/health"
        echo "ðŸ“ API Docs: https://$APP_URL/docs"
        echo "=========================================="
        
        # GitHub Step Summaryì— ì¶”ê°€
        echo "## ðŸŽ‰ ë°°í¬ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ **App URL**: https://$APP_URL" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’š **Health Check**: https://$APP_URL/health" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“š **API Docs**: https://$APP_URL/docs" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ·ï¸ **Image Tag**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
