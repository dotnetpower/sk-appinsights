{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## ğŸ“Š ETF Agent - ì—°ê²°ëœ ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§\n\n---\n\nì´ ëŒ€ì‹œë³´ë“œëŠ” ETF Agent ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ì—°ê²°ëœ ëª¨ë“  ì„œë¹„ìŠ¤ì˜ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤."
      },
      "name": "text - 0"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "1f74ed9a-e3ed-498d-8f88-122db7b479e1",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "ì‹œê°„ ë²”ìœ„",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 3600000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                }
              ],
              "allowCustom": true
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "parameters - 1"
    },
    {
      "type": 1,
      "content": {
        "json": "---\n## ğŸ“Š ì—°ê²°ëœ ì„œë¹„ìŠ¤ ëª©ë¡\n"
      },
      "name": "text - 2",
      "customWidth": "100"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "union dependencies, requests\n| where timestamp {TimeRange}\n| extend ServiceName = coalesce(\n    tostring(customDimensions.['ai.cloud.role']),\n    tostring(cloud_RoleName),\n    iff(itemType == 'dependency', tostring(target), 'API Server')\n)\n| extend ServiceType = case(\n    tostring(type) contains 'Cosmos' or tostring(target) contains 'cosmos', 'ğŸ—„ï¸ Cosmos DB',\n    tostring(type) contains 'HTTP' or tostring(type) contains 'Ajax', 'ğŸŒ External API',\n    tostring(type) contains 'SQL', 'ğŸ’¾ SQL Database',\n    itemType == 'request', 'âš™ï¸ API Server',\n    strcat('ğŸ“¦ ', tostring(type))\n)\n| summarize \n    TotalCalls = count(),\n    SuccessRate = round(100.0 * countif(success == true) / count(), 2),\n    AvgDuration = round(avg(duration), 2),\n    P95Duration = round(percentile(duration, 95), 2),\n    MaxDuration = round(max(duration), 2),\n    FailedCalls = countif(success == false)\n    by ServiceName, ServiceType\n| extend Status = iff(SuccessRate >= 99, 'âœ… ì •ìƒ', iff(SuccessRate >= 95, 'âš ï¸ ì£¼ì˜', 'âŒ ì˜¤ë¥˜'))\n| project \n    Status,\n    ServiceType,\n    ServiceName,\n    TotalCalls,\n    ['ì„±ê³µë¥  (%)'] = SuccessRate,\n    ['í‰ê·  ì‘ë‹µì‹œê°„ (ms)'] = AvgDuration,\n    ['P95 ì‘ë‹µì‹œê°„ (ms)'] = P95Duration,\n    ['ìµœëŒ€ ì‘ë‹µì‹œê°„ (ms)'] = MaxDuration,\n    ['ì‹¤íŒ¨ ê±´ìˆ˜'] = FailedCalls\n| order by TotalCalls desc",
        "size": 0,
        "title": "ì„œë¹„ìŠ¤ë³„ í˜¸ì¶œ í†µê³„",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "thresholdValue": "ì •ìƒ",
                    "representation": "success",
                    "text": ""
                  },
                  {
                    "operator": "contains",
                    "thresholdValue": "ì£¼ì˜",
                    "representation": "warning",
                    "text": ""
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "error",
                    "text": ""
                  }
                ]
              }
            },
            {
              "columnMatch": "ì„±ê³µë¥  (%)",
              "formatter": 8,
              "formatOptions": {
                "palette": "greenRed"
              }
            },
            {
              "columnMatch": "í‰ê·  ì‘ë‹µì‹œê°„ (ms)",
              "formatter": 8,
              "formatOptions": {
                "palette": "blue"
              }
            }
          ]
        }
      },
      "name": "query - 3",
      "styleSettings": {
        "margin": "10px",
        "padding": "0px"
      }
    },
    {
      "type": 1,
      "content": {
        "json": "---\n## ğŸ—„ï¸ Cosmos DB ìƒì„¸ ëª¨ë‹ˆí„°ë§\n"
      },
      "name": "text - 4",
      "customWidth": "100"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "dependencies\n| where timestamp {TimeRange}\n| where tostring(type) contains 'Cosmos' or tostring(target) contains 'cosmos'\n| extend Operation = tostring(customDimensions.['db.operation'])\n| summarize \n    Calls = count(),\n    SuccessRate = round(100.0 * countif(success == true) / count(), 2),\n    AvgDuration = round(avg(duration), 2),\n    P95Duration = round(percentile(duration, 95), 2)\n    by Operation, target\n| extend OperationType = iff(isempty(Operation), 'Unknown', Operation)\n| project \n    ['Cosmos DB ì—”ë“œí¬ì¸íŠ¸'] = target,\n    ['ì‘ì—… ìœ í˜•'] = OperationType,\n    ['í˜¸ì¶œ ìˆ˜'] = Calls,\n    ['ì„±ê³µë¥  (%)'] = SuccessRate,\n    ['í‰ê·  ì‹œê°„ (ms)'] = AvgDuration,\n    ['P95 ì‹œê°„ (ms)'] = P95Duration\n| order by ['í˜¸ì¶œ ìˆ˜'] desc",
        "size": 0,
        "title": "Cosmos DB ì‘ì—…ë³„ í†µê³„",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "query - 5",
      "styleSettings": {
        "margin": "10px"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "dependencies\n| where timestamp {TimeRange}\n| where tostring(type) contains 'Cosmos' or tostring(target) contains 'cosmos'\n| summarize \n    Calls = count(),\n    AvgDuration = avg(duration)\n    by bin(timestamp, 5m)\n| render timechart with (title=\"Cosmos DB í˜¸ì¶œ ì¶”ì´\", xtitle=\"ì‹œê°„\", ytitle=\"í˜¸ì¶œ ìˆ˜ / í‰ê·  ì‘ë‹µì‹œê°„(ms)\")",
        "size": 0,
        "title": "Cosmos DB ì‹œê°„ë³„ í˜¸ì¶œ ì¶”ì´",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "query - 6",
      "styleSettings": {
        "margin": "10px"
      }
    },
    {
      "type": 1,
      "content": {
        "json": "---\n## ğŸŒ ì™¸ë¶€ API í˜¸ì¶œ ëª¨ë‹ˆí„°ë§\n"
      },
      "name": "text - 7",
      "customWidth": "100"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "dependencies\n| where timestamp {TimeRange}\n| where tostring(type) contains 'HTTP' or tostring(type) contains 'Ajax'\n| extend ApiHost = tostring(split(tostring(target), '/')[0])\n| summarize \n    Calls = count(),\n    SuccessRate = round(100.0 * countif(success == true) / count(), 2),\n    AvgDuration = round(avg(duration), 2),\n    Failures = countif(success == false)\n    by ApiHost, type\n| project \n    ['API í˜¸ìŠ¤íŠ¸'] = ApiHost,\n    ['íƒ€ì…'] = type,\n    ['í˜¸ì¶œ ìˆ˜'] = Calls,\n    ['ì„±ê³µë¥  (%)'] = SuccessRate,\n    ['í‰ê·  ì‹œê°„ (ms)'] = AvgDuration,\n    ['ì‹¤íŒ¨ ìˆ˜'] = Failures\n| order by ['í˜¸ì¶œ ìˆ˜'] desc",
        "size": 0,
        "title": "ì™¸ë¶€ API í˜¸ì¶œ í†µê³„ (yfinance ë“±)",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "query - 8",
      "styleSettings": {
        "margin": "10px"
      }
    },
    {
      "type": 1,
      "content": {
        "json": "---\n## âš™ï¸ API ì—”ë“œí¬ì¸íŠ¸ ì„±ëŠ¥\n"
      },
      "name": "text - 9",
      "customWidth": "100"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "requests\n| where timestamp {TimeRange}\n| extend Endpoint = strcat(tostring(customDimensions.['http.method']), ' ', tostring(url))\n| summarize \n    Calls = count(),\n    SuccessRate = round(100.0 * countif(success == true) / count(), 2),\n    AvgDuration = round(avg(duration), 2),\n    P95Duration = round(percentile(duration, 95), 2),\n    Failures = countif(success == false)\n    by name, resultCode\n| project \n    ['ì—”ë“œí¬ì¸íŠ¸'] = name,\n    ['ìƒíƒœ ì½”ë“œ'] = resultCode,\n    ['í˜¸ì¶œ ìˆ˜'] = Calls,\n    ['ì„±ê³µë¥  (%)'] = SuccessRate,\n    ['í‰ê·  ì‹œê°„ (ms)'] = AvgDuration,\n    ['P95 ì‹œê°„ (ms)'] = P95Duration,\n    ['ì‹¤íŒ¨ ìˆ˜'] = Failures\n| order by ['í˜¸ì¶œ ìˆ˜'] desc",
        "size": 0,
        "title": "API ì—”ë“œí¬ì¸íŠ¸ë³„ ì„±ëŠ¥",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "query - 10",
      "styleSettings": {
        "margin": "10px"
      }
    },
    {
      "type": 1,
      "content": {
        "json": "---\n## âŒ ì˜¤ë¥˜ ë° ì˜ˆì™¸\n"
      },
      "name": "text - 11",
      "customWidth": "100"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "union \n    (exceptions | extend itemKind = 'exception'),\n    (traces | where severityLevel >= 2 | extend itemKind = 'trace'),\n    (requests | where success == false | extend itemKind = 'failed_request'),\n    (dependencies | where success == false | extend itemKind = 'failed_dependency')\n| where timestamp {TimeRange}\n| extend \n    ErrorType = case(\n        itemKind == 'exception', strcat('âŒ Exception: ', tostring(type)),\n        itemKind == 'trace', strcat('âš ï¸ Trace (Level ', tostring(severityLevel), ')'),\n        itemKind == 'failed_request', strcat('ğŸ”´ Failed Request (', tostring(resultCode), ')'),\n        itemKind == 'failed_dependency', strcat('ğŸ”´ Failed Dependency: ', tostring(type)),\n        'Other'\n    ),\n    ErrorMessage = case(\n        itemKind == 'exception', tostring(outerMessage),\n        itemKind == 'trace', tostring(message),\n        itemKind == 'failed_request', strcat(tostring(name), ' - ', tostring(url)),\n        itemKind == 'failed_dependency', strcat(tostring(name), ' -> ', tostring(target)),\n        'Unknown'\n    )\n| summarize \n    Count = count(),\n    LatestOccurrence = max(timestamp),\n    FirstOccurrence = min(timestamp)\n    by ErrorType, ErrorMessage\n| project \n    ['ì˜¤ë¥˜ íƒ€ì…'] = ErrorType,\n    ['ë©”ì‹œì§€ ìš”ì•½'] = substring(ErrorMessage, 0, 80),\n    ['ë°œìƒ íšŸìˆ˜'] = Count,\n    ['ìµœê·¼ ë°œìƒ'] = LatestOccurrence,\n    ['ìµœì´ˆ ë°œìƒ'] = FirstOccurrence,\n    FullMessage = ErrorMessage\n| order by ['ë°œìƒ íšŸìˆ˜'] desc\n| take 20",
        "size": 0,
        "title": "ìµœê·¼ ì˜¤ë¥˜ ë° ì˜ˆì™¸ (Top 20) - í–‰ í´ë¦­í•˜ì—¬ ìƒì„¸ í™•ì¸",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "ì˜¤ë¥˜ íƒ€ì…",
              "formatter": 1
            },
            {
              "columnMatch": "ë°œìƒ íšŸìˆ˜",
              "formatter": 8,
              "formatOptions": {
                "palette": "redBright"
              }
            },
            {
              "columnMatch": "FullMessage",
              "formatter": 5
            }
          ],
          "rowLimit": 20,
          "labelSettings": [
            {
              "columnId": "ë©”ì‹œì§€ ìš”ì•½",
              "label": "ë©”ì‹œì§€ (í´ë¦­í•˜ì—¬ ì „ì²´ ë³´ê¸°)"
            }
          ],
          "hierarchySettings": {
            "treeType": 1
          }
        },
        "sortBy": [],
        "exportFieldName": "ì˜¤ë¥˜ íƒ€ì…",
        "exportParameterName": "SelectedErrorType",
        "exportToExcelOptions": "visible",
        "showExportToExcel": true,
        "tileSettings": {
          "showBorder": false
        }
      },
      "name": "query - 12",
      "styleSettings": {
        "margin": "10px"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "error-selection",
            "version": "KqlParameterItem/1.0",
            "name": "SelectedErrorType",
            "label": "ğŸ“Œ ì˜¤ë¥˜ ì„ íƒ (ìƒì„¸ ë¡œê·¸ í™•ì¸)",
            "type": 2,
            "query": "union \n    (exceptions | extend itemKind = 'exception'),\n    (traces | where severityLevel >= 2 | extend itemKind = 'trace'),\n    (requests | where success == false | extend itemKind = 'failed_request'),\n    (dependencies | where success == false | extend itemKind = 'failed_dependency')\n| where timestamp {TimeRange}\n| extend \n    ErrorType = case(\n        itemKind == 'exception', strcat('âŒ Exception: ', tostring(type)),\n        itemKind == 'trace', strcat('âš ï¸ Trace (Level ', tostring(severityLevel), ')'),\n        itemKind == 'failed_request', strcat('ğŸ”´ Failed Request (', tostring(resultCode), ')'),\n        itemKind == 'failed_dependency', strcat('ğŸ”´ Failed Dependency: ', tostring(type)),\n        'Other'\n    )\n| summarize Count = count() by ErrorType\n| order by Count desc\n| project value = ErrorType, label = strcat(ErrorType, ' (', Count, 'ê±´)')",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.insights/components"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "parameters - 13"
    },
    {
      "type": 1,
      "content": {
        "json": "---\n### ğŸ“‹ ì„ íƒí•œ ì˜¤ë¥˜ì˜ ìƒì„¸ ë¡œê·¸ (ìµœê·¼ 10ê±´)\n"
      },
      "conditionalVisibility": {
        "parameterName": "SelectedErrorType",
        "comparison": "isNotEqualTo"
      },
      "name": "text - 14"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let selectedError = '{SelectedErrorType}';\nunion \n    (exceptions \n     | extend itemKind = 'exception',\n              ErrorType = strcat('âŒ Exception: ', tostring(type)),\n              ErrorMessage = tostring(outerMessage),\n              DetailJson = pack('Method', method, 'Assembly', assembly, 'OuterType', outerType, 'InnerMessage', innermostMessage)\n    ),\n    (traces \n     | where severityLevel >= 2\n     | extend itemKind = 'trace',\n              ErrorType = strcat('âš ï¸ Trace (Level ', tostring(severityLevel), ')'),\n              ErrorMessage = tostring(message),\n              DetailJson = pack('Severity', severityLevel, 'Level', case(severityLevel == 0, 'Verbose', severityLevel == 1, 'Info', severityLevel == 2, 'Warning', severityLevel == 3, 'Error', severityLevel == 4, 'Critical', 'Unknown'))\n    ),\n    (requests \n     | where success == false\n     | extend itemKind = 'failed_request',\n              ErrorType = strcat('ğŸ”´ Failed Request (', tostring(resultCode), ')'),\n              ErrorMessage = strcat(tostring(name), ' - ', tostring(url)),\n              DetailJson = pack('Method', customDimensions.['http.method'], 'URL', url, 'ResultCode', resultCode, 'Duration_ms', duration)\n    ),\n    (dependencies \n     | where success == false\n     | extend itemKind = 'failed_dependency',\n              ErrorType = strcat('ğŸ”´ Failed Dependency: ', tostring(type)),\n              ErrorMessage = strcat(tostring(name), ' -> ', tostring(target)),\n              DetailJson = pack('Type', type, 'Target', target, 'ResultCode', resultCode, 'Duration_ms', duration)\n    )\n| where timestamp {TimeRange}\n| where isnotempty(selectedError) and ErrorType == selectedError\n| project \n    ['ë°œìƒ ì‹œê°'] = format_datetime(timestamp, 'yyyy-MM-dd HH:mm:ss'),\n    ['ì˜¤ë¥˜ íƒ€ì…'] = ErrorType,\n    ['ì „ì²´ ë©”ì‹œì§€'] = ErrorMessage,\n    ['ìƒì„¸ ì •ë³´'] = DetailJson,\n    ['Operation ID'] = operation_Id\n| order by ['ë°œìƒ ì‹œê°'] desc\n| take 10",
        "size": 0,
        "title": "ì˜¤ë¥˜ ë°œìƒ ë‚´ì—­",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "ì „ì²´ ë©”ì‹œì§€",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "40%"
              }
            },
            {
              "columnMatch": "ìƒì„¸ ì •ë³´",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "CellDetails",
                "linkLabel": "ğŸ“„ ìƒì„¸ ë³´ê¸°"
              }
            },
            {
              "columnMatch": "Operation ID",
              "formatter": 5
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "SelectedErrorType",
        "comparison": "isNotEqualTo"
      },
      "name": "query - 15",
      "styleSettings": {
        "margin": "10px"
      }
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/microsoft.insights/components/YOUR_APP_INSIGHTS_NAME"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
